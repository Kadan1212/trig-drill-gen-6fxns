<script>
function generateDrill({
  useDegrees = true,
  radians = false,
  tan: includeTan = false,
  cot: includeCot = false,
  sec: includeSec = false,
  csc: includeCsc = false,
  deg90s = true,
  deg30s = true,
  deg45s = true,
  include360 = true,
  coterminal = false,
  quadIOnly = false
} = {}) {

  function invert(value) {
    if (value === 0) return null;
    if (value === null) return 0;
    if (typeof value === 'number') return 1 / value;
    const neg = value.startsWith('-');
    const val = neg ? value.slice(1) : value;
    let result;
    if (val === '1/2') result = 2;
    else if (val === 'rt2/2') result = 'rt2';
    else if (val === 'rt3/2') result = '2/rt3';
    else if (val === 'rt3/3') result = 'rt3';
    else if (val === 'rt3') result = 'rt3/3';
    else if (val === '2/rt3') result = 'rt3/2';
    else if (val === 'rt2') result = 'rt2/2';
    else result = 1 / parseFloat(val);
    return neg ? '-' + result : result;
  }

  const answers = {
    0: [0, 1, 0],
    30: ['1/2', 'rt3/2', 'rt3/3'],
    45: ['rt2/2', 'rt2/2', 1],
    60: ['rt3/2', '1/2', 'rt3'],
    90: [1, 0, null]
  };

  function getAnswers(degrees) {
    degrees = (degrees % 360 + 360) % 360;
    if (answers[degrees]) return answers[degrees].slice();
    if (degrees === 180) { const t = answers[0].slice(); t[1] = -1; return t; }
    if (degrees === 270) { const t = answers[90].slice(); t[0] = -1; return t; }
    if (degrees > 90 && degrees < 180) { const t = answers[180 - degrees].slice(); if (typeof t[1] === 'string') t[1] = '-' + t[1]; else t[1] *= -1; if (typeof t[2] === 'string') t[2] = '-' + t[2]; else t[2] *= -1; return t; }
    if (degrees > 180 && degrees < 270) { const t = answers[degrees - 180].slice(); if (typeof t[0] === 'string') t[0] = '-' + t[0]; else t[0] *= -1; if (typeof t[1] === 'string') t[1] = '-' + t[1]; else t[1] *= -1; return t; }
    if (degrees > 270 && degrees < 360) { const t = answers[360 - degrees].slice(); if (typeof t[0] === 'string') t[0] = '-' + t[0]; else t[0] *= -1; if (typeof t[2] === 'string') t[2] = '-' + t[2]; else t[2] *= -1; return t; }
    throw new Error('Unknown degree: ' + degrees);
  }

  const problems = [];

  function angle(degrees, getCoterminals = true) {
    const [sin, cos, tan] = getAnswers(degrees);
    if (getCoterminals && coterminal) {
      if (degrees !== 360) angle(degrees - 360, false);
      angle(degrees + 360, false);
    }
    if (useDegrees) {
      problems.push({fn: 'sin', arg: degrees, type: 'degrees', answer: sin});
      problems.push({fn: 'cos', arg: degrees, type: 'degrees', answer: cos});
      if (includeTan) problems.push({fn: 'tan', arg: degrees, type: 'degrees', answer: tan});
      if (includeCot) problems.push({fn: 'cot', arg: degrees, type: 'degrees', answer: invert(tan)});
      if (includeSec) problems.push({fn: 'sec', arg: degrees, type: 'degrees', answer: invert(cos)});
      if (includeCsc) problems.push({fn: 'csc', arg: degrees, type: 'degrees', answer: invert(sin)});
    }
  }

  if (deg90s) { angle(0); angle(90); if (!quadIOnly) { angle(180); angle(270); } }
  if (include360) angle(360);
  if (deg30s) { angle(30); angle(60); if (!quadIOnly) { angle(120); angle(150); angle(210); angle(240); angle(300); angle(330); } }
  if (deg45s) { angle(45); if (!quadIOnly) { angle(135); angle(225); angle(315); } }

  return problems;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

const checkboxes = {
  useDegrees: document.getElementById('degrees'),
  radians: document.getElementById('radian'),
  tan: document.getElementById('tan'),
  cot: document.getElementById('cot'),
  sec: document.getElementById('sec'),
  csc: document.getElementById('csc'),
  deg90s: document.getElementById('deg90s'),
  deg30s: document.getElementById('deg30s'),
  deg45s: document.getElementById('deg45s'),
  include360: document.getElementById('include360'),
  coterminal: document.getElementById('coterminal'),
  quadIOnly: document.getElementById('quadionly'),
  showCorrectness: document.getElementById('showcorrectness'),
  showCorrect: document.getElementById('showcorrect'),
  showTime: document.getElementById('showtime'),
  limit20: document.getElementById('limit20')
};

const clock = document.getElementById('clock');
const problemsWrapper = document.getElementById('problems');
const score = document.getElementById('score');
const solutions = document.getElementById('solutions');

const solutionHTMLs = {};
Array.from(solutions.children).forEach(solution => {
  solutionHTMLs[solution.dataset.answer] = solution.innerHTML;
});

let problems, problem, wrongs, rights, startTime, clockStopper = null, playing = false;

function startClock() {
  clock.textContent = formatTime(Date.now() - startTime);
  clockStopper = window.requestAnimationFrame(startClock);
}

function formatTime(time) {
  const minutes = Math.floor(time / 60000);
  const seconds = Math.floor(time / 1000) % 60;
  const milliseconds = time % 1000;
  return minutes.toString().padStart(2,'0') + ':' + seconds.toString().padStart(2,'0') + '.' + milliseconds.toString().padStart(3,'0');
}

document.getElementById('start').addEventListener('click', e => {
  if (playing) return;

  const options = {};
  Object.keys(checkboxes).forEach(key => options[key] = checkboxes[key].checked);

  problems = generateDrill(options);
  problems = shuffle(problems);

  if (!problems.length) {
    alert('Your settings disallow problems of any kind. Make them more lenient please!');
    return;
  }

  if (options.limit20) problems = problems.slice(0, 20);

  if (options.showCorrectness) document.body.classList.add('show-wrong'); else document.body.classList.remove('show-wrong');
  if (options.showCorrect) document.body.classList.add('show-correct'); else document.body.classList.remove('show-correct');
  if (options.showTime) document.body.classList.add('show-time');

  let html = '';
  problems.forEach(({fn, arg, type, answer}) => {
    html += `<div class="problem"><span class="answer">${solutionHTMLs[answer]}</span><span><span class="fn">${fn}</span>`;
    html += arg + (type === 'degrees' ? '&deg;' : '');
    html += '</span></div>';
  });
  problemsWrapper.innerHTML = html;
  problemsWrapper.children[0].classList.add('current');

  wrongs = rights = 0;
  startTime = Date.now();
  startClock();
  document.body.style.setProperty('--problem-n', problem = 0);
  document.body.classList.remove('show-intro-modal');
  playing = true;
});

const keyCodeToAnswer = {
  81: '1/2', 87: 'rt2/2', 69: 'rt3/2', 82: '1',
  65: '-1/2', 83: '-rt2/2', 68: '-rt3/2', 70: '-1',
  32: '0'
};

document.addEventListener('keydown', e => {
  if (keyCodeToAnswer[e.keyCode]) submitAnswer(keyCodeToAnswer[e.keyCode]);
});

solutions.addEventListener('click', e => {
  const solution = e.target.closest('.solution');
  if (solution) submitAnswer(solution.dataset.answer);
});

function submitAnswer(answer) {
  if (!playing) return;
  if (answer === '0' || answer === '1' || answer === '-1') answer = +answer;
  else if (answer === 'null') answer = null;

  if (answer === problems[problem].answer) {
    problemsWrapper.children[problem].classList.add('correct');
    rights++;
  } else {
    problemsWrapper.children[problem].classList.add('wrong');
    wrongs++;
  }

  problemsWrapper.children[problem].classList.remove('current');
  problem++;

  if (problem >= problems.length) {
    playing = false;
    window.cancelAnimationFrame(clockStopper);
    const time = Date.now() - startTime;
    score.innerHTML = `It took you <strong>${formatTime(time)}</strong> to get <strong>${rights}</strong> out of ${problems.length} correct.`;
    document.body.classList.add('show-intro-modal', 'show-score');
    document.body.classList.remove('show-time');
    return;
  }

  document.body.style.setProperty('--problem-n', problem);
  problemsWrapper.children[problem].classList.add('current');
}

document.getElementById('menu').addEventListener('click', e => {
  document.body.classList.remove('show-score');
});
</script>
